<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100vw; height:100vh; background:black; overflow:hidden;
      font-family:sans-serif; display:flex; flex-direction:column; align-items:center;
    }
    .page-wrapper{
      aspect-ratio:9 / 16; width:100%; height:100vh; max-width:56.25vh;
      display:flex; flex-direction:column; background:white;
    }
    .banner-container{ position:relative; width:100%; aspect-ratio:9 / 5; overflow:hidden; }
    .banner-container video{ width:100%; height:100%; object-fit:cover; display:block; background:black; }
    .back-to-menu{
      position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,.6); color:#fff;
      padding:8px 12px; border-radius:8px; font-size:12px; z-index:10; user-select:none;
      line-height:1.2;
    }
    .shop-grid{
      flex:1; display:grid; grid-template-columns:repeat(4,1fr); grid-auto-rows:1fr;
      gap:6px; padding:10px; overflow-y:auto; width:100%; background:white;
    }
    .shop-card{
      background:#222; border-radius:8px; overflow:hidden; display:flex; flex-direction:column;
      align-items:center; text-align:center; color:white; font-size:14px;
    }
    .shop-card img{ width:100%; height:auto; object-fit:cover; display:block; }
    .shop-card .shop-name{ padding:4px; }
    .shop-card.empty{ background:#ddd; border:1px dashed #aaa; }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="banner-container">
      <video id="bannerVideo" autoplay muted playsinline preload="metadata">
        <source id="bannerSrc" src="" type="video/mp4" />
      </video>
      <div id="backBtn" class="back-to-menu">↩️ back to<br>main menu</div>
    </div>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

<script>
  // ===== PARAMETERS =====
  const qs = new URLSearchParams(location.search);
  const type = qs.get('type') || 'dining';
  const projectId = qs.get('project_id') || '';

  // ===== BASE PATH (สำคัญ แก้ 404) =====
  // ถ้าหน้านี้ถูกเสิร์ฟจาก /ann/... ให้ลิงก์ทุกอย่างขึ้นต้นด้วย /ann/
  // แก้ไขเป็น relative path สำหรับ local development
  const withBase = (p) => './' + p.replace(/^\.?\//, '');

  // ===== BANNER VIDEO (ยึด path ที่ยืนยันแล้ว) =====
  const bannerVideo = document.getElementById('bannerVideo');
  const bannerSrc   = document.getElementById('bannerSrc');
  bannerSrc.src = `/opt/yodeck/medias/${type}.mp4`;
  bannerVideo.muted = true;
  bannerVideo.setAttribute('playsinline', '');
  bannerVideo.setAttribute('autoplay', '');
  bannerVideo.load();
  bannerVideo.play().catch(()=>{});

  // ===== BACK TO MENU (พก project_id กลับ) =====
  const backBtn = document.getElementById('backBtn');
  if (backBtn) {
    backBtn.onclick = () => {
      const u = new URL('./menu.html', location.origin);
      if (projectId) u.searchParams.set('project_id', projectId);
      location.href = u.toString();
    };
  } else {
    console.error('backBtn element not found');
  }

  // ===== LOAD ITEMS BY CATEGORY =====
  async function loadCategoryItems() {
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    let filteredItems = [];

    try {
      if (type === 'delivery') {
        // Load restaurants with delivery service
        const restaurants = await fetch(withBase('data/rest.json')).then(r => r.json());
        filteredItems = restaurants.filter(item =>
          (item.type === 'delivery' || item.type === 'both') &&
          item.projects.includes(projectId) &&
          item.status === 'active'
        );
      } else if (type === 'dining') {
        // Load restaurants for dine-in
        const restaurants = await fetch(withBase('data/rest.json')).then(r => r.json());
        filteredItems = restaurants.filter(item =>
          (item.type === 'dine' || item.type === 'both') &&
          item.projects.includes(projectId) &&
          item.status === 'active'
        );
      } else if (type === 'daily') {
        // Load shops with non-service items
        const shops = await fetch(withBase('data/shop.json')).then(r => r.json());
        filteredItems = shops.filter(item =>
          item.type === 'non-service' &&
          item.projects.includes(projectId) &&
          item.status === 'active'
        );
      } else if (type === 'ondemand') {
        // Load shops with service items
        const shops = await fetch(withBase('data/shop.json')).then(r => r.json());
        filteredItems = shops.filter(item =>
          item.type === 'service' &&
          item.projects.includes(projectId) &&
          item.status === 'active'
        );
      } else if (type === 'deal') {
        // Load unit deals
        const unitData = await fetch(withBase('data/unit.json')).then(r => r.json());
        filteredItems = unitData.units.filter(item =>
          item.project_id === projectId &&
          (item.condition?.selling_price || item.condition?.rental_price) // Units with pricing
        );
        // Transform unit data for display
        filteredItems.forEach(unit => {
          unit.name_th = `${unit.unit?.room_type || 'ห้อง'} ${unit.unit?.unit_number || ''}`;
          unit.name_en = `${unit.unit?.room_type || 'Unit'} ${unit.unit?.unit_number || ''}`;
          unit.id = unit.unit_id; // For navigation
        });
      } else {
        // Fallback: try to load from existing category files
        const categoryData = await fetch(withBase(`data/${type}.json`)).then(r => r.json()).catch(() => []);
        filteredItems = Array.isArray(categoryData) ? categoryData : [];
      }

      // Render filtered items
      let count = 0;
      filteredItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-card';

        // Get item name and image (different structure for units vs shops/restaurants)
        const itemName = item.name_th || (item.unit ? `${item.unit.unit_number} - ${item.unit.room_type}` : item.id) || 'Unknown';
        let itemImage = null;

        // Priority order: images array (first item) > logo > fallback to MP4 video > placeholder
        if (item.images && Array.isArray(item.images) && item.images.length > 0) {
          itemImage = item.images[0]; // Use first image from array
        } else if (item.logo) {
          itemImage = item.logo; // Use logo as fallback
        } else if (item.image && item.image.endsWith('.MP4')) {
          // For MP4 files, try to find corresponding image
          const baseName = item.image.replace('medias/', '').replace('.MP4', '');
          const correspondingImage = `images/${baseName.replace(/\d+$/, '1')}.jpg`;
          itemImage = correspondingImage;
        } else if (item.image) {
          itemImage = item.image; // Use direct image reference
        }

        // Final fallback
        if (!itemImage) {
          itemImage = 'logos/placeholder.png';
        }

        div.innerHTML = `
          <img src="${withBase(itemImage)}" alt="${itemName}" onerror="this.onerror=null; this.src='/opt/yodeck/medias/placeholder.jpg'" style="width: 100%; height: 60%; object-fit: cover;">
          <div class="shop-name" style="padding: 8px; font-size: 12px; text-align: center;">${itemName}</div>
        `;

        // Add click handler for navigation
        div.addEventListener('click', () => {
          if (type === 'daily' || type === 'ondemand') {
            window.location.href = `shop-signage.html?shop=${encodeURIComponent(item.id)}&project_id=${encodeURIComponent(projectId)}`;
          } else if (type === 'delivery' || type === 'dining') {
            window.location.href = `rest-signage.html?rest=${encodeURIComponent(item.id)}&project_id=${encodeURIComponent(projectId)}`;
          } else if (type === 'deal') {
            window.location.href = `unit-signage.html?id=${encodeURIComponent(item.unit_id)}&project_id=${encodeURIComponent(projectId)}`;
          }
        });

        grid.appendChild(div);
        count++;
      });

      // Fill empty slots
      for (let i = count; i < 12; i++) {
        const div = document.createElement('div');
        div.className = 'shop-card empty';
        grid.appendChild(div);
      }

      console.log(`Loaded ${count} items for category: ${type}, project: ${projectId}`);

    } catch (err) {
      console.error('Error loading category items:', err);
    }
  }

  loadCategoryItems();

  // ===== AUTO RETURN 1 นาที → menu.html =====
  let timeout;
  function resetInactivityTimer(){
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      // Check if we're in /ann/ directory for correct path
      const currentPath = window.location.pathname;
      const menuPath = currentPath.includes('/ann/') ? './menu.html' : './ann/menu.html';
      const u = new URL(menuPath, location.origin);
      if (projectId) u.searchParams.set('project_id', projectId);
      location.href = u.toString();
    }, 60000);
  }
  ['click','touchstart','mousemove'].forEach(ev =>
    window.addEventListener(ev, resetInactivityTimer)
  );
  resetInactivityTimer();

  // ===== VERSION POLL (ตามเดิม) =====
  window.currentVersion = '';
  setInterval(() => {
    fetch('./version.txt', { cache: 'no-store' })
      .then(res => res.text())
      .then(v => {
        const t = v.trim();
        if (window.currentVersion && window.currentVersion !== t) location.reload();
        window.currentVersion = t;
      })
      .catch(()=>{});
  }, 60000);
</script>
</body>
</html>